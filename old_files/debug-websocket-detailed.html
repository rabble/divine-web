<!DOCTYPE html>
<html>
<head>
    <title>Detailed WebSocket Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .timing { color: orange; }
        pre { background: #f0f0f0; padding: 10px; }
    </style>
</head>
<body>
    <h1>Detailed WebSocket Connection Debug</h1>
    <div id="log"></div>

    <script>
        const startTime = Date.now();
        const log = (msg, type = 'info') => {
            const elapsed = Date.now() - startTime;
            console.log(`[${elapsed}ms] ${msg}`);
            const div = document.getElementById('log');
            div.innerHTML += `<p class="${type}">[${elapsed}ms] ${msg}</p>`;
        };

        // Test relay.divine.video with detailed timing
        log('=== RELAY.DIVINE.VIDEO TEST ===', 'info');
        log(`Browser: ${navigator.userAgent}`, 'info');
        log(`Creating WebSocket to wss://relay.divine.video`, 'info');

        const ws = new WebSocket('wss://relay.divine.video');
        let connectTime = null;
        let firstMessageTime = null;

        // Set a timeout to check connection state
        const checkInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            log(`[CHECK] readyState=${ws.readyState} (0=CONNECTING, 1=OPEN, 2=CLOSING, 3=CLOSED)`, 'timing');
        }, 5000);

        ws.onopen = () => {
            connectTime = Date.now() - startTime;
            clearInterval(checkInterval);
            log(`‚úÖ WebSocket OPENED after ${connectTime}ms`, 'success');
            log(`readyState: ${ws.readyState}`, 'success');

            // Send a test REQ
            const req = JSON.stringify(['REQ', 'debug-test', { kinds: [34236], limit: 3 }]);
            log(`Sending REQ: ${req}`, 'info');
            ws.send(req);
        };

        ws.onerror = (error) => {
            const elapsed = Date.now() - startTime;
            log(`‚ùå WebSocket ERROR after ${elapsed}ms`, 'error');
            log(`Error type: ${error.type}`, 'error');
            log(`readyState: ${ws.readyState}`, 'error');
        };

        ws.onclose = (event) => {
            const elapsed = Date.now() - startTime;
            clearInterval(checkInterval);
            log(`‚ùå WebSocket CLOSED after ${elapsed}ms`, 'error');
            log(`Code: ${event.code}, Reason: "${event.reason}", Clean: ${event.wasClean}`, 'error');

            // Summary
            log(`\n=== SUMMARY ===`, 'info');
            log(`Connection time: ${connectTime || 'NEVER CONNECTED'}ms`, connectTime ? 'success' : 'error');
            log(`First message time: ${firstMessageTime || 'NO MESSAGES'}ms`, firstMessageTime ? 'success' : 'error');
        };

        ws.onmessage = (event) => {
            if (!firstMessageTime) {
                firstMessageTime = Date.now() - startTime;
                log(`üì• First message received after ${firstMessageTime}ms`, 'success');
            }

            const msg = JSON.parse(event.data);
            if (msg[0] === 'EVENT') {
                log(`üì• EVENT: ${msg[2].id.substring(0, 16)}...`, 'success');
            } else if (msg[0] === 'EOSE') {
                log(`üì• EOSE received`, 'success');
                log(`Total time: ${Date.now() - startTime}ms`, 'timing');
                ws.close();
            } else {
                log(`üì• ${msg[0]}`, 'info');
            }
        };

        // Timeout after 2 minutes
        setTimeout(() => {
            if (ws.readyState !== WebSocket.OPEN && ws.readyState !== WebSocket.CLOSED) {
                log(`‚è±Ô∏è TIMEOUT after 120 seconds - connection never opened`, 'error');
                log(`Final readyState: ${ws.readyState}`, 'error');
                clearInterval(checkInterval);
                ws.close();
            }
        }, 120000);
    </script>
</body>
</html>
